import{d as F,g as v,G,h as H,L as x,c,b as s,a as r,w as u,F as D,n as A,p as Q,q as U,M as $,K as j,P as J,r as m,o as _,e as T,Q as W,m as w,R as z,t as g,S as X,_ as Y}from"./main-3abf4ed4.js";import{b as y}from"./mockData-70ed22ed.js";const Z={class:"chat-page"},ee={class:"chat-container"},te={class:"conversation-sidebar"},se={class:"sidebar-header"},ae={class:"conversation-list"},oe=["onClick"],ne={class:"conv-title"},ie={class:"conv-time"},le={class:"chat-main"},re={class:"message-avatar"},de={key:0},ce={key:1},ue={class:"message-content"},_e={class:"message-text"},ve={class:"message-time"},pe={class:"chat-input-area"},me={class:"input-container"},ge={class:"input-actions"},he=F({__name:"Chat",setup(fe){const L=$(),p=v(),d=v(""),h=v(!1),l=v([]),o=v(null),C=G(()=>L.query.poem);H(async()=>{await N(),C.value&&B(C.value)});const N=async()=>{try{const{data:e,error:t}=await x.from("ai_conversations").select("*").order("created_at",{ascending:!1});t?(console.error("加载对话失败:",t),l.value=y()):e&&e.length>0?l.value=e.map(a=>({id:a.id,userId:a.user_id,poemId:a.poem_id,title:a.title,messages:a.messages||[],createdAt:a.created_at,updatedAt:a.updated_at})):l.value=y(),l.value.length>0&&(o.value=l.value[0])}catch(e){console.error("加载对话异常:",e),l.value=y(),l.value.length>0&&(o.value=l.value[0])}},I=()=>{const e={id:Date.now().toString(),userId:"",poemId:null,title:"新对话",messages:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};l.value.unshift(e),o.value=e},V=e=>{o.value=e},B=e=>{d.value="请帮我分析一下这首诗词"},k=async()=>{if(!d.value.trim())return;o.value||I();const e={id:Date.now().toString(),conversationId:o.value.id,role:"user",content:d.value,timestamp:new Date};o.value.messages.push(e),o.value.messages.length===1&&(o.value.title=d.value.slice(0,20)+"..."),M();const t=d.value;d.value="",h.value=!0;try{await new Promise(f=>setTimeout(f,1e3));const a=await K(t),i={id:(Date.now()+1).toString(),conversationId:o.value.id,role:"assistant",content:a,timestamp:new Date};o.value.messages.push(i),M(),await R(o.value)}catch(a){console.error("发送消息失败:",a),j.error("发送失败，请重试")}finally{h.value=!1}},K=async e=>{const t=["这首诗词表达了深切的思乡之情，通过月光意象营造出宁静而忧郁的氛围。","从文学角度看，这首诗运用了对比手法，将自然景物与内心情感巧妙结合。","这首诗的意境深远，语言简练，体现了作者高超的艺术造诣。","从历史背景来看，这首诗反映了当时文人的普遍情感和时代特征。","这首诗的韵律优美，结构严谨，是古典诗词的典范之作。"];return t[Math.floor(Math.random()*t.length)]},R=async e=>{try{const t={id:e.id,user_id:e.userId,poem_id:e.poemId,title:e.title,messages:e.messages.map(i=>({id:i.id,conversation_id:i.conversationId,role:i.role,content:i.content,created_at:i.timestamp.toISOString()})),created_at:e.createdAt,updated_at:e.updatedAt},{error:a}=await x.from("ai_conversations").upsert(t);a&&console.error("保存对话失败:",a)}catch(t){console.error("保存对话异常:",t)}},O=()=>{d.value=""},M=()=>{J(()=>{p.value&&(p.value.scrollTop=p.value.scrollHeight)})},P=e=>new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),q=e=>e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});return(e,t)=>{var S;const a=m("el-icon"),i=m("el-button"),f=m("el-avatar"),E=m("el-input");return _(),c("div",Z,[t[6]||(t[6]=s("div",{class:"page-header"},[s("h1",{class:"page-title"},"AI诗词助手"),s("p",{class:"page-subtitle"},"与AI讨论诗词，获得个性化解析")],-1)),s("div",ee,[s("div",te,[s("div",se,[t[2]||(t[2]=s("h3",null,"对话历史",-1)),r(i,{type:"primary",size:"small",onClick:I},{default:u(()=>[r(a,null,{default:u(()=>[r(T(W))]),_:1}),t[1]||(t[1]=w(" 新建对话 ",-1))]),_:1})]),s("div",ae,[(_(!0),c(D,null,A(l.value,n=>{var b;return _(),c("div",{key:n.id,class:z(["conversation-item",{active:((b=o.value)==null?void 0:b.id)===n.id}]),onClick:we=>V(n)},[s("div",ne,g(n.title),1),s("div",ie,g(P(n.created_at)),1)],10,oe)}),128))])]),s("div",le,[s("div",{class:"chat-messages",ref_key:"messagesContainer",ref:p},[(_(!0),c(D,null,A((S=o.value)==null?void 0:S.messages,n=>(_(),c("div",{key:n.id,class:z(["message",n.role])},[s("div",re,[r(f,{size:32},{default:u(()=>[n.role==="user"?(_(),c("span",de,"👤")):(_(),c("span",ce,"🤖"))]),_:2},1024)]),s("div",ue,[s("div",_e,g(n.content),1),s("div",ve,g(q(n.timestamp)),1)])],2))),128))],512),s("div",pe,[s("div",me,[r(E,{modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=n=>d.value=n),type:"textarea",rows:3,placeholder:"输入您的问题或想讨论的诗词...",onKeydown:Q(U(k,["prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),s("div",ge,[r(i,{type:"primary",onClick:k,loading:h.value},{default:u(()=>[r(a,null,{default:u(()=>[...t[3]||(t[3]=[s("svg",{viewBox:"0 0 1024 1024",width:"16",height:"16"},[s("path",{fill:"currentColor",d:"M931.4 498.9L94.9 79.5c-3.4-1.7-7.3-2.1-11-1.2-3.7 0.9-6.9 3-9 6.1-2.1 3.1-3.1 6.8-2.7 10.5l86.3 352.8-86.3 352.8c-0.4 3.7 0.6 7.4 2.7 10.5 2.1 3.1 5.3 5.2 9 6.1 0.8 0.2 1.6 0.3 2.4 0.3 2.9 0 5.7-0.9 8.1-2.6l836.5-419.4c3.1-1.6 5.2-4.5 5.9-7.8 0.7-3.3-0.1-6.7-2.1-9.3-1.9-2.6-4.9-4.2-8.1-4.2zM170.8 834.3l63.3-258.9 258.9-63.3-258.9-63.3-63.3-258.9 580.5 290.3-580.5 290.3z"})],-1)])]),_:1}),t[4]||(t[4]=w(" 发送 ",-1))]),_:1},8,["loading"]),r(i,{onClick:O},{default:u(()=>[r(a,null,{default:u(()=>[r(T(X))]),_:1}),t[5]||(t[5]=w(" 清空 ",-1))]),_:1})])])])])])])}}});const Ie=Y(he,[["__scopeId","data-v-b1f96083"]]);export{Ie as default};
